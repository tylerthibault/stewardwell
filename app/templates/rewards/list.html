{% extends "base.html" %}

{% block title %}Rewards{% endblock %}

{% block authenticated_content %}
<div class="content-container">
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h1>Rewards</h1>
            {% if current_user.is_parent %}
                <p class="text-muted">Manage family rewards</p>
            {% else %}
                <p class="text-muted">Your Coins: {{ user_coins }}</p>
            {% endif %}
        </div>
        {% if current_user.is_parent %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRewardModal">
            <i class="fas fa-plus"></i> Add Reward
        </button>
        {% endif %}
    </div>

    <!-- Rewards by Category -->
    <div class="accordion" id="rewardsAccordion">
        {% for category in categories %}
        {% set category_rewards = rewards|selectattr('category_id', 'equalto', category.id)|list %}
        {% if category_rewards %}
        <div class="accordion-item mb-3">
            <h2 class="accordion-header" id="heading{{ category.id }}">
                <button class="accordion-button" type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ category.id }}"
                        style="border-left: 4px solid {{ category.color }}">
                    <i class="fas {{ category.icon }} me-2"></i>
                    {{ category.name }}
                    <span class="badge bg-secondary ms-2">{{ category_rewards|length }}</span>
                </button>
            </h2>
            <div id="collapse{{ category.id }}" 
                 class="accordion-collapse collapse"
                 data-bs-parent="#rewardsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        {% for reward in category_rewards %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ reward.title }}</h5>
                                        {% if current_user.is_parent %}
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editRewardModal{{ reward.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form action="{{ url_for('rewards.toggle_reward', reward_id=reward.id) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-{{ 'warning' if reward.is_available else 'success' }}"
                                                            title="{{ 'Disable reward' if reward.is_available else 'Enable reward' }}">
                                                        <i class="fas {{ 'fa-pause' if reward.is_available else 'fa-play' }}"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if reward.description %}
                                        <p class="card-text">{{ reward.description }}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="coins-badge">
                                            <i class="fas fa-coins"></i> {{ reward.cost }}
                                        </span>
                                        
                                        {% if not current_user.is_parent and reward.is_available %}
                                            <form action="{{ url_for('rewards.redeem_reward', reward_id=reward.id) }}" method="POST">
                                                <button type="submit" class="btn btn-success btn-sm" 
                                                        {% if user_coins < reward.cost %}disabled{% endif %}
                                                        title="{% if user_coins < reward.cost %}Not enough coins{% endif %}">
                                                    Redeem
                                                </button>
                                            </form>
                                        {% elif not reward.is_available %}
                                            <span class="badge bg-secondary">Currently Unavailable</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Reward Modal - Inside the reward loop -->
                        {% if current_user.is_parent %}
                        <div class="modal fade" id="editRewardModal{{ reward.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Reward</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form action="{{ url_for('rewards.edit_reward', reward_id=reward.id) }}" method="POST">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label for="title{{ reward.id }}" class="form-label">Title</label>
                                                <input type="text" class="form-control" id="title{{ reward.id }}" 
                                                       name="title" value="{{ reward.title }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="description{{ reward.id }}" class="form-label">Description</label>
                                                <textarea class="form-control" id="description{{ reward.id }}" 
                                                        name="description" rows="3">{{ reward.description }}</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="category_id{{ reward.id }}" class="form-label">Category</label>
                                                <select class="form-control" id="category_id{{ reward.id }}" name="category_id">
                                                    <option value="">No Category</option>
                                                    {% for category in categories %}
                                                    <option value="{{ category.id }}" {% if reward.category_id == category.id %}selected{% endif %}>
                                                        {{ category.name }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="cost{{ reward.id }}" class="form-label">Cost (coins)</label>
                                                <input type="number" class="form-control" id="cost{{ reward.id }}" 
                                                       name="cost" value="{{ reward.cost }}" required min="0">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Save Changes</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <!-- Uncategorized Rewards -->
        {% set uncategorized_rewards = rewards|selectattr('category_id', 'none')|list %}
        {% if uncategorized_rewards %}
        <div class="accordion-item mb-3">
            <h2 class="accordion-header" id="headingUncategorized">
                <button class="accordion-button" type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapseUncategorized">
                    <i class="fas fa-list me-2"></i>
                    Uncategorized
                    <span class="badge bg-secondary ms-2">{{ uncategorized_rewards|length }}</span>
                </button>
            </h2>
            <div id="collapseUncategorized" 
                 class="accordion-collapse collapse"
                 data-bs-parent="#rewardsAccordion">
                <div class="accordion-body">
                    <div class="row">
                        {% for reward in uncategorized_rewards %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ reward.title }}</h5>
                                        {% if current_user.is_parent %}
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editRewardModal{{ reward.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form action="{{ url_for('rewards.toggle_reward', reward_id=reward.id) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-{{ 'warning' if reward.is_available else 'success' }}"
                                                            title="{{ 'Disable reward' if reward.is_available else 'Enable reward' }}">
                                                        <i class="fas {{ 'fa-pause' if reward.is_available else 'fa-play' }}"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if reward.description %}
                                        <p class="card-text">{{ reward.description }}</p>
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="coins-badge">
                                            <i class="fas fa-coins"></i> {{ reward.cost }}
                                        </span>
                                        
                                        {% if not current_user.is_parent and reward.is_available %}
                                            <form action="{{ url_for('rewards.redeem_reward', reward_id=reward.id) }}" method="POST">
                                                <button type="submit" class="btn btn-success btn-sm" 
                                                        {% if user_coins < reward.cost %}disabled{% endif %}
                                                        title="{% if user_coins < reward.cost %}Not enough coins{% endif %}">
                                                    Redeem
                                                </button>
                                            </form>
                                        {% elif not reward.is_available %}
                                            <span class="badge bg-secondary">Currently Unavailable</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Pending Redemptions -->
    {% if pending_redemptions %}
    <div class="card mt-4">
        <div class="card-header">
            <h3>{% if current_user.is_parent %}Pending Redemptions{% else %}Your Redemptions{% endif %}</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Reward</th>
                            <th>Cost</th>
                            {% if current_user.is_parent %}
                                <th>Requested By</th>
                            {% endif %}
                            <th>Requested</th>
                            <th>Status</th>
                            {% if current_user.is_parent %}
                                <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for redemption in pending_redemptions %}
                        <tr>
                            <td>{{ redemption.reward.title }}</td>
                            <td>{{ redemption.cost }}</td>
                            {% if current_user.is_parent %}
                                <td>{{ redemption.user.username }}</td>
                            {% endif %}
                            <td>{{ redemption.redeemed_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <span class="badge bg-{{ 'warning' if redemption.status == 'pending' else 'success' if redemption.status == 'approved' else 'danger' }}">
                                    {{ redemption.status.title() }}
                                </span>
                            </td>
                            {% if current_user.is_parent and redemption.status == 'pending' %}
                            <td>
                                <div class="btn-group">
                                    <form action="{{ url_for('rewards.handle_redemption', redemption_id=redemption.id, action='approve') }}" 
                                          method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                    <form action="{{ url_for('rewards.handle_redemption', redemption_id=redemption.id, action='deny') }}" 
                                          method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Reward Modal -->
{% if current_user.is_parent %}
<div class="modal fade" id="addRewardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Reward</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('rewards.create_reward') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category</label>
                        <select class="form-control" id="category_select" onchange="handleCategorySelect(this)">
                            <option value="">No Category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                            <option value="new">+ Add New Category</option>
                        </select>
                        
                        <!-- Hidden category input fields -->
                        <div id="new_category_container" style="display: none;" class="mt-2">
                            <input type="text" class="form-control mb-2" 
                                   id="new_category_name" 
                                   placeholder="Enter new category name">
                            <div class="row">
                                <div class="col-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-palette"></i>
                                        </span>
                                        <input type="color" 
                                               class="form-control form-control-color" 
                                               id="new_category_color" 
                                               value="#6c757d">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-icons"></i>
                                        </span>
                                        <select class="form-control" id="new_category_icon">
                                            <option value="fa-gift">Gift</option>
                                            <option value="fa-gamepad">Game</option>
                                            <option value="fa-ice-cream">Treat</option>
                                            <option value="fa-ticket">Event</option>
                                            <option value="fa-dollar-sign">Money</option>
                                            <option value="fa-clock">Time</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden input to store the final category_id -->
                        <input type="hidden" name="category_id" id="category_id">
                    </div>
                    <div class="mb-3">
                        <label for="cost" class="form-label">Cost (coins)</label>
                        <input type="number" class="form-control" id="cost" name="cost" required min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Reward</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Add edit modals for uncategorized rewards -->
{% for reward in uncategorized_rewards %}
<div class="modal fade" id="editRewardModal{{ reward.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Reward</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('rewards.edit_reward', reward_id=reward.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title{{ reward.id }}" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title{{ reward.id }}" 
                               name="title" value="{{ reward.title }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="description{{ reward.id }}" class="form-label">Description</label>
                        <textarea class="form-control" id="description{{ reward.id }}" 
                                name="description" rows="3">{{ reward.description }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category_select{{ reward.id }}" class="form-label">Category</label>
                        <select class="form-control" id="category_select{{ reward.id }}" 
                                onchange="handleEditCategorySelect(this, {{ reward.id }})">
                            <option value="">No Category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if reward.category_id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                            <option value="new">+ Add New Category</option>
                        </select>
                        
                        <!-- Hidden category input fields -->
                        <div id="new_category_container{{ reward.id }}" style="display: none;" class="mt-2">
                            <input type="text" class="form-control mb-2" 
                                   id="new_category_name{{ reward.id }}" 
                                   placeholder="Enter new category name">
                            <div class="row">
                                <div class="col-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-palette"></i>
                                        </span>
                                        <input type="color" 
                                               class="form-control form-control-color" 
                                               id="new_category_color{{ reward.id }}" 
                                               value="#6c757d">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-icons"></i>
                                        </span>
                                        <select class="form-control" id="new_category_icon{{ reward.id }}">
                                            <option value="fa-gift">Gift</option>
                                            <option value="fa-gamepad">Game</option>
                                            <option value="fa-ice-cream">Treat</option>
                                            <option value="fa-ticket">Event</option>
                                            <option value="fa-dollar-sign">Money</option>
                                            <option value="fa-clock">Time</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden input to store the final category_id -->
                        <input type="hidden" name="category_id" id="category_id{{ reward.id }}">
                    </div>
                    <div class="mb-3">
                        <label for="cost{{ reward.id }}" class="form-label">Cost (coins)</label>
                        <input type="number" class="form-control" id="cost{{ reward.id }}" 
                               name="cost" value="{{ reward.cost }}" required min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Add some custom styles -->
<style>
.accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    box-shadow: none;
}

.accordion-button:focus {
    box-shadow: none;
}

.accordion-item {
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,.125);
}

.accordion-button {
    padding: 1rem;
    font-weight: 500;
}

.accordion-button .badge {
    font-size: 0.8rem;
    padding: 0.35em 0.65em;
}

.accordion-button::after {
    margin-left: auto;
}

.accordion-body {
    padding: 1.5rem;
    background-color: white;
}
</style>

<!-- Add the JavaScript for category handling -->
<script>
function handleCategorySelect(selectElement) {
    const newCategoryContainer = document.getElementById('new_category_container');
    const categoryIdInput = document.getElementById('category_id');
    
    if (selectElement.value === 'new') {
        newCategoryContainer.style.display = 'block';
        categoryIdInput.value = '';
        // Clear any previous inputs
        document.getElementById('new_category_name').value = '';
        document.getElementById('new_category_color').value = '#6c757d';
        document.getElementById('new_category_icon').value = 'fa-gift';
    } else {
        newCategoryContainer.style.display = 'none';
        categoryIdInput.value = selectElement.value;
    }
}

// Add form submit handler
document.addEventListener('DOMContentLoaded', function() {
    const addRewardForm = document.querySelector('#addRewardModal form');
    if (addRewardForm) {
        addRewardForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const categorySelect = document.getElementById('category_select');
            
            if (categorySelect.value === 'new') {
                const categoryName = document.getElementById('new_category_name').value;
                if (!categoryName) {
                    alert('Please enter a category name');
                    return;
                }
                
                try {
                    const response = await fetch("{{ url_for('rewards.create_category') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: categoryName,
                            color: document.getElementById('new_category_color').value,
                            icon: document.getElementById('new_category_icon').value
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        document.getElementById('category_id').value = result.category_id;
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Error creating category');
                        return;
                    }
                } catch (error) {
                    alert('Error creating category');
                    return;
                }
            }
            
            this.submit();
        });
    }
});

// Add this new function for edit modal category handling
function handleEditCategorySelect(selectElement, rewardId) {
    const newCategoryContainer = document.getElementById(`new_category_container${rewardId}`);
    const categoryIdInput = document.getElementById(`category_id${rewardId}`);
    
    if (selectElement.value === 'new') {
        newCategoryContainer.style.display = 'block';
        categoryIdInput.value = '';
        // Clear any previous inputs
        document.getElementById(`new_category_name${rewardId}`).value = '';
        document.getElementById(`new_category_color${rewardId}`).value = '#6c757d';
        document.getElementById(`new_category_icon${rewardId}`).value = 'fa-gift';
    } else {
        newCategoryContainer.style.display = 'none';
        categoryIdInput.value = selectElement.value;
    }
}

// Add form submit handler for edit forms
document.addEventListener('DOMContentLoaded', function() {
    const editForms = document.querySelectorAll('[id^="editRewardModal"] form');
    editForms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rewardId = this.closest('.modal').id.replace('editRewardModal', '');
            const categorySelect = document.getElementById(`category_select${rewardId}`);
            
            if (categorySelect.value === 'new') {
                const categoryName = document.getElementById(`new_category_name${rewardId}`).value;
                if (!categoryName) {
                    alert('Please enter a category name');
                    return;
                }
                
                try {
                    const response = await fetch("{{ url_for('rewards.create_category') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: categoryName,
                            color: document.getElementById(`new_category_color${rewardId}`).value,
                            icon: document.getElementById(`new_category_icon${rewardId}`).value
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        document.getElementById(`category_id${rewardId}`).value = result.category_id;
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Error creating category');
                        return;
                    }
                } catch (error) {
                    alert('Error creating category');
                    return;
                }
            }
            
            this.submit();
        });
    });
});
</script>
{% endblock %} 