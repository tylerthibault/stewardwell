{% extends "inside/dashboard.html" %}

{% block dashboard_content %}
<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold">{{ budget.name }}</h2>
            <p class="text-gray-600">{{ budget.description }}</p>
        </div>
        <div class="text-right">
            <p class="text-sm text-gray-600">Total Budget</p>
            <p class="text-2xl font-bold">${{ "%.2f"|format(budget.total_amount) }}</p>
        </div>
    </div>

    <!-- Categories Overview -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Budget Categories</h3>
            {% if user.is_parent_in_family(budget.family_id) %}
            <button onclick="showAddCategoryModal()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Add Category
            </button>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for category in categories %}
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold">{{ category.name }}</h4>
                    {% if user.is_parent_in_family(budget.family_id) %}
                    <button class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Planned</span>
                        <span>${{ "%.2f"|format(category.planned_amount) }}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Actual</span>
                        <span>${{ "%.2f"|format(category.actual_amount) }}</span>
                    </div>
                    <div class="flex justify-between text-sm font-semibold">
                        <span>Remaining</span>
                        <span class="{{ 'text-red-600' if category.remaining_amount < 0 else 'text-green-600' }}">
                            ${{ "%.2f"|format(category.remaining_amount) }}
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        {% set percentage = (category.actual_amount / category.planned_amount * 100) if category.planned_amount > 0 else 0 %}
                        {% set width = percentage if percentage <= 100 else 100 %}
                        {% set color = 'bg-red-600' if percentage > 100 else 'bg-blue-600' %}
                        <div class="{{ color }} h-2.5 rounded-full" style="width: {{ width }}%"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Transactions -->
    <div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Transactions</h3>
            <button onclick="showAddTransactionModal()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Add Transaction
            </button>
        </div>

        {% if transactions %}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Added By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for transaction in transactions|sort(attribute='date', reverse=True) %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ transaction.date.strftime('%Y-%m-%d') }}
                        </td>
                        <td class="px-6 py-4">
                            {{ transaction.description }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ transaction.category.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${{ "%.2f"|format(transaction.amount) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ transaction.user.first_name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if transaction.user_id == user.id %}
                            <div class="flex space-x-2">
                                <button onclick="showMoveTransactionModal({{ transaction.id }}, '{{ transaction.description }}', {{ transaction.category_id }})" 
                                        class="text-blue-600 hover:text-blue-900">
                                    Move
                                </button>
                                <button onclick="deleteTransaction({{ transaction.id }})" 
                                        class="text-red-600 hover:text-red-900">
                                    Delete
                                </button>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-6 text-center">
            <p class="text-gray-600">No transactions recorded yet.</p>
            <button onclick="showAddTransactionModal()" 
                    class="text-blue-500 hover:text-blue-700">
                Add your first transaction
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Transaction Modal -->
<div id="addTransactionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Add Transaction</h3>
            <form action="{{ url_for('add_transaction', family_id=budget.family_id, budget_id=budget.id) }}" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Description</label>
                    <input type="text" name="description" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Category</label>
                    <select name="category_id" required
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Amount</label>
                    <input type="number" name="amount" step="0.01" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Date</label>
                    <input type="date" name="date" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideAddTransactionModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Add Budget Category</h3>
            <form action="{{ url_for('add_category', family_id=budget.family_id, budget_id=budget.id) }}" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Category Name</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                           placeholder="e.g., Groceries">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Planned Amount</label>
                    <input type="number" name="planned_amount" step="0.01" min="0" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                           placeholder="0.00">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideAddCategoryModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Move Transaction Modal -->
<div id="moveTransactionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Move Transaction</h3>
            <p id="moveTransactionDescription" class="text-gray-600 mb-4"></p>
            <form id="moveTransactionForm" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">New Category</label>
                    <select name="new_category_id" id="newCategorySelect" required
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideMoveTransactionModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Move Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentTransactionId = null;

function showAddTransactionModal() {
    document.getElementById('addTransactionModal').classList.remove('hidden');
}

function hideAddTransactionModal() {
    document.getElementById('addTransactionModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('addTransactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideAddTransactionModal();
    }
});

function showAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.remove('hidden');
}

function hideAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('addCategoryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideAddCategoryModal();
    }
});

function showMoveTransactionModal(transactionId, description, currentCategoryId) {
    currentTransactionId = transactionId;
    document.getElementById('moveTransactionDescription').textContent = `Move transaction: ${description}`;
    document.getElementById('newCategorySelect').value = currentCategoryId;
    document.getElementById('moveTransactionModal').classList.remove('hidden');
    
    // Update form action
    const form = document.getElementById('moveTransactionForm');
    form.action = `/family/${familyId}/budget/${budgetId}/transaction/${transactionId}/move`;
}

function hideMoveTransactionModal() {
    document.getElementById('moveTransactionModal').classList.add('hidden');
    currentTransactionId = null;
}

// Close modal when clicking outside
document.getElementById('moveTransactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideMoveTransactionModal();
    }
});

// Add these variables at the top of your script
const familyId = '{{ budget.family_id }}';
const budgetId = '{{ budget.id }}';

// Update your existing moveTransactionForm submit handler
document.getElementById('moveTransactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newCategoryId = document.getElementById('newCategorySelect').value;
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_category_id: newCategoryId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error moving transaction: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error moving transaction');
    });
});
</script>
{% endblock %} 