{% extends "inside/dashboard.html" %}

{% block dashboard_content %}
<!-- Include the subnav -->
{% include "inside/components/chores_subnav.html" %}

<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Manage Rewards</h2>
        <div class="space-x-4">
            <button onclick="showAddRewardModal('individual')" 
                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                Add Individual Reward
            </button>
        </div>
    </div>

    <!-- Individual Rewards Section -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold mb-4">Individual Rewards</h3>
        {% if individual_rewards %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for reward in individual_rewards %}
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold">{{ reward.name }}</h4>
                    <div class="flex space-x-2">
                        <button onclick="editReward({{ reward.id }})"
                                class="text-blue-600 hover:text-blue-900">
                            Edit
                        </button>
                        <form action="{{ url_for('toggle_reward', family_id=family.id, reward_id=reward.id) }}" 
                              method="POST" 
                              class="inline-block">
                            <button type="submit" 
                                    class="px-2 py-1 text-sm rounded {% if reward.available %}bg-red-500 hover:bg-red-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white">
                                {% if reward.available %}
                                    Disable
                                {% else %}
                                    Enable
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
                <p class="text-gray-600 mb-2">{{ reward.description }}</p>
                <div class="text-sm">
                    <span class="text-green-600">{{ reward.coin_cost }} coins</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-6 text-center">
            <p class="text-gray-600">No individual rewards created yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Family Goals Section -->
    <div>
        <h3 class="text-xl font-semibold mb-4">Family Goals</h3>
        {% if family_rewards %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for reward in family_rewards %}
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold">{{ reward.name }}</h4>
                    <div class="flex space-x-2">
                        <button onclick="editReward({{ reward.id }})"
                                class="text-blue-600 hover:text-blue-900">
                            Edit
                        </button>
                        <form action="{{ url_for('toggle_reward', family_id=family.id, reward_id=reward.id) }}" 
                              method="POST" 
                              class="inline-block">
                            <button type="submit" 
                                    class="px-2 py-1 text-sm rounded {% if reward.available %}bg-red-500 hover:bg-red-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white">
                                {% if reward.available %}
                                    Disable
                                {% else %}
                                    Enable
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
                <p class="text-gray-600 mb-2">{{ reward.description }}</p>
                <div class="text-sm">
                    <span class="text-blue-600">{{ reward.points_required }} family points</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-6 text-center">
            <p class="text-gray-600">No family goals created yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Reward Modal -->
<div id="rewardModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4" id="modalTitle">Add Reward</h3>
            <form id="rewardForm" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Name</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Description</label>
                    <textarea name="description" rows="3"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"></textarea>
                </div>
                <div id="coinCostField" class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Coin Cost</label>
                    <input type="number" name="coin_cost" min="0"
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div id="pointsRequiredField" class="mb-4 hidden">
                    <label class="block text-gray-700 font-bold mb-2">Points Required</label>
                    <input type="number" name="points_required" min="0"
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <input type="hidden" name="is_family_reward" value="false">
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideRewardModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Save Reward
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentRewardType = 'individual';

function showAddRewardModal(type) {
    currentRewardType = type;
    const form = document.getElementById('rewardForm');
    form.action = "{{ url_for('manage_rewards', family_id=family.id) }}";
    form.reset();
    
    document.getElementById('modalTitle').textContent = 
        type === 'family' ? 'Add Family Goal' : 'Add Individual Reward';
    
    document.querySelector('input[name="is_family_reward"]').value = 
        type === 'family' ? 'true' : 'false';
    
    toggleRewardFields(type);
    document.getElementById('rewardModal').classList.remove('hidden');
}

function hideRewardModal() {
    document.getElementById('rewardModal').classList.add('hidden');
}

function toggleRewardFields(type) {
    const coinField = document.getElementById('coinCostField');
    const pointsField = document.getElementById('pointsRequiredField');
    
    if (type === 'family') {
        coinField.classList.add('hidden');
        pointsField.classList.remove('hidden');
        coinField.querySelector('input').required = false;
        pointsField.querySelector('input').required = true;
    } else {
        coinField.classList.remove('hidden');
        pointsField.classList.add('hidden');
        coinField.querySelector('input').required = true;
        pointsField.querySelector('input').required = false;
    }
}

function editReward(rewardId) {
    const reward = {{ rewards|tojson|safe }}.find(r => r.id === rewardId);
    if (!reward) return;

    currentRewardType = reward.is_family_reward ? 'family' : 'individual';
    
    const form = document.getElementById('rewardForm');
    form.action = `/family/{{ family.id }}/rewards/${rewardId}/edit`;
    form.name.value = reward.name;
    form.description.value = reward.description;
    
    if (reward.is_family_reward) {
        form.points_required.value = reward.points_required;
    } else {
        form.coin_cost.value = reward.coin_cost;
    }
    
    document.getElementById('modalTitle').textContent = 
        reward.is_family_reward ? 'Edit Family Goal' : 'Edit Individual Reward';
    
    document.querySelector('input[name="is_family_reward"]').value = 
        reward.is_family_reward ? 'true' : 'false';
    
    toggleRewardFields(currentRewardType);
    document.getElementById('rewardModal').classList.remove('hidden');
}

// Close modal when clicking outside
document.getElementById('rewardModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideRewardModal();
    }
});
</script>
{% endblock %} 