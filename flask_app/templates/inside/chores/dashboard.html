{% extends "inside/dashboard.html" %}

{% block dashboard_content %}
<!-- Include the subnav -->
{% include "inside/components/chores_subnav.html" %}

<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">{{ family.name }} - Chores & Rewards</h2>
        {% if user.is_parent_in_family(family.id) %}
        <div class="space-x-4">
            <a href="{{ url_for('create_chore', family_id=family.id) }}" 
               class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Create New Chore
            </a>
        </div>
        {% endif %}
    </div>

    {% if user.is_parent_in_family(family.id) %}
    <!-- Parent View: Chores by Family Member -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold mb-4">Family Members</h3>
        
        {% for member in family.members if member.role == 'child' %}
        <div class="bg-white rounded-lg shadow mb-6">
            <!-- Member Header -->
            <div class="px-6 py-4 border-b bg-gray-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold text-lg">{{ member.user.first_name }}'s Dashboard</h4>
                        <p class="text-sm text-gray-600">Balance: {{ member.user.coin_balance }} coins</p>
                    </div>
                    <div class="flex space-x-4">
                        <a href="{{ url_for('switch_child_view', family_id=family.id, child_id=member.user.id) }}" 
                           class="text-blue-600 hover:text-blue-800">
                            View As {{ member.user.first_name }}
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Content Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
                <!-- Pending Chores Section -->
                <div class="bg-white rounded border">
                    <div class="px-4 py-2 bg-gray-50 border-b">
                        <h5 class="font-medium">Pending Chores</h5>
                    </div>
                    <div class="p-4">
                        {% set member_chores = member.user.chores_assigned|selectattr('status', 'equalto', 'pending')|list %}
                        {% if member_chores %}
                        <div class="space-y-3">
                            {% for assignment in member_chores %}
                            <div class="flex justify-between items-start border-b pb-3 last:border-0 last:pb-0">
                                <div>
                                    <p class="font-medium">{{ assignment.chore.name }}</p>
                                    <p class="text-sm text-gray-600">{{ assignment.chore.description }}</p>
                                    <div class="text-sm mt-1">
                                        <span class="text-green-600">+{{ assignment.chore.coin_value }} coins</span>
                                        <span class="text-blue-600 ml-2">+{{ assignment.chore.family_points }} points</span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="showCloneChoreModal({{ assignment.chore.id }}, '{{ assignment.chore.name }}')"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        Clone
                                    </button>
                                    <button onclick="unassignChore({{ assignment.id }})"
                                            class="text-red-600 hover:text-red-900 text-sm">
                                        Unassign
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-gray-600 text-center">No pending chores</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Awaiting Approval Section -->
                <div class="bg-white rounded border">
                    <div class="px-4 py-2 bg-gray-50 border-b">
                        <h5 class="font-medium">Awaiting Approval</h5>
                    </div>
                    <div class="p-4">
                        {% set completed_chores = member.user.chores_assigned|selectattr('status', 'equalto', 'completed')|list %}
                        {% if completed_chores %}
                        <div class="space-y-3">
                            {% for assignment in completed_chores %}
                            <div class="flex justify-between items-start border-b pb-3 last:border-0 last:pb-0">
                                <div>
                                    <p class="font-medium">{{ assignment.chore.name }}</p>
                                    <p class="text-sm text-gray-600">Completed: {{ assignment.completed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="approveChore({{ assignment.id }})"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        Approve
                                    </button>
                                    <button onclick="rejectChore({{ assignment.id }})"
                                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        Reject
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-gray-600 text-center">No chores awaiting approval</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Pending Rewards Section -->
                <div class="bg-white rounded border">
                    <div class="px-4 py-2 bg-gray-50 border-b">
                        <h5 class="font-medium">Pending Rewards</h5>
                    </div>
                    <div class="p-4">
                        {% set member_redemptions = child_redemptions.get(member.user.id, []) %}
                        {% if member_redemptions %}
                        <div class="space-y-3">
                            {% for redemption in member_redemptions %}
                            <div class="flex justify-between items-start border-b pb-3 last:border-0 last:pb-0">
                                <div>
                                    <p class="font-medium">{{ redemption.reward.name }}</p>
                                    <p class="text-sm text-gray-600">{{ redemption.reward.description }}</p>
                                    <div class="text-sm mt-1">
                                        {% if redemption.reward.is_family_reward %}
                                        <span class="text-blue-600">{{ redemption.reward.points_required }} points</span>
                                        {% else %}
                                        <span class="text-green-600">{{ redemption.reward.coin_cost }} coins</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="approveRedemption({{ redemption.id }})"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        Approve
                                    </button>
                                    <button onclick="rejectRedemption({{ redemption.id }})"
                                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        Reject
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-gray-600 text-center">No pending reward redemptions</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="bg-white rounded border">
                    <div class="px-4 py-2 bg-gray-50 border-b">
                        <h5 class="font-medium">Recent Activity</h5>
                    </div>
                    <div class="p-4">
                        {% if member.recent_approved %}
                        <div class="space-y-3">
                            {% for assignment in member.recent_approved %}
                            <div class="border-b pb-3 last:border-0 last:pb-0">
                                <p class="font-medium">{{ assignment.chore.name }}</p>
                                <p class="text-sm text-gray-600">Approved: {{ assignment.approved_at.strftime('%Y-%m-%d %H:%M') }}</p>
                                <div class="text-sm mt-1">
                                    <span class="text-green-600">+{{ assignment.chore.coin_value }} coins earned</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-gray-600 text-center">No recent activity</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Unassigned Chores -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold mb-4">Unassigned Chores</h3>
        <div class="bg-white rounded-lg shadow">
            <div class="divide-y">
                {% if unassigned_chores %}
                {% for chore in unassigned_chores %}
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h5 class="font-medium">{{ chore.name }}</h5>
                            <p class="text-sm text-gray-600">{{ chore.description }}</p>
                            <div class="text-sm mt-1">
                                <span class="text-green-600">{{ chore.coin_value }} coins</span>
                                <span class="text-blue-600 ml-2">{{ chore.family_points }} family points</span>
                                {% if chore.recurring %}
                                <span class="text-purple-600 ml-2">Recurring: {{ chore.recurring_frequency }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="space-x-2">
                            <button onclick="showAssignChoreModal({{ chore.id }})"
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Assign
                            </button>
                            <button onclick="showCloneChoreModal({{ chore.id }}, '{{ chore.name }}')"
                                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Clone
                            </button>
                            <button onclick="deleteChore({{ chore.id }}, '{{ chore.name }}')"
                                    class="text-red-600 hover:text-red-900">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="p-6 text-center text-gray-600">
                    No unassigned chores
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- Child View: My Chores -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">My Chores</h3>
            <div class="text-lg">
                <span class="text-green-600 font-semibold">{{ user.coin_balance }} coins</span>
            </div>
        </div>
        
        <!-- Pending Chores -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b">
                <h4 class="font-semibold">To Do</h4>
            </div>
            {% if pending_assignments %}
            <div class="divide-y">
                {% for assignment in pending_assignments %}
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h5 class="font-medium">{{ assignment.chore.name }}</h5>
                            <p class="text-sm text-gray-600">{{ assignment.chore.description }}</p>
                            <div class="text-sm mt-1">
                                <span class="text-green-600">+{{ assignment.chore.coin_value }} coins</span>
                                <span class="text-blue-600 ml-2">+{{ assignment.chore.family_points }} family points</span>
                            </div>
                        </div>
                        <button onclick="completeChore({{ assignment.id }})"
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            Mark Complete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-6 text-center text-gray-600">
                No pending chores
            </div>
            {% endif %}
        </div>

        <!-- Completed Chores -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b">
                <h4 class="font-semibold">Completed</h4>
            </div>
            {% if completed_assignments %}
            <div class="divide-y">
                {% for assignment in completed_assignments %}
                <div class="p-4 bg-gray-50">
                    <h5 class="font-medium">{{ assignment.chore.name }}</h5>
                    <p class="text-sm text-gray-600">Completed: {{ assignment.completed_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    <div class="text-sm mt-1">
                        <span class="text-yellow-600">Waiting for parent approval</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-6 text-center text-gray-600">
                No completed chores
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Assign Chore Modal -->
<div id="assignChoreModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Assign Chore</h3>
            <form id="assignChoreForm" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Assign To</label>
                    <select name="assigned_to_id" required
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        {% for member in family.members if member.role == 'child' %}
                        <option value="{{ member.user.id }}">{{ member.user.first_name }} {{ member.user.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideAssignChoreModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Assign
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Clone Chore Modal -->
<div id="cloneChoreModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Clone Chore</h3>
            <p id="cloneChoreDescription" class="text-gray-600 mb-4"></p>
            <form id="cloneChoreForm" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Assign To</label>
                    <select name="assigned_to_id" required
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        {% for member in family.members if member.role == 'child' %}
                        <option value="{{ member.user.id }}">{{ member.user.first_name }} {{ member.user.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideCloneChoreModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Clone Chore
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentChoreId = null;
let currentChoreToClone = null;

function showAssignChoreModal(choreId) {
    currentChoreId = choreId;
    const modal = document.getElementById('assignChoreModal');
    const form = document.getElementById('assignChoreForm');
    form.action = `/family/{{ family.id }}/chores/${choreId}/assign`;
    modal.classList.remove('hidden');
}

function hideAssignChoreModal() {
    document.getElementById('assignChoreModal').classList.add('hidden');
    currentChoreId = null;
}

function completeChore(assignmentId) {
    if (!confirm('Mark this chore as complete?')) return;
    
    fetch(`/family/{{ family.id }}/chores/assignment/${assignmentId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Chore completed successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error completing chore: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error completing chore', 'error');
    });
}

function approveChore(assignmentId) {
    if (!confirm('Approve this chore?')) return;
    
    fetch(`/family/{{ family.id }}/chores/assignment/${assignmentId}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Chore approved successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error approving chore: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error approving chore', 'error');
    });
}

function rejectChore(assignmentId) {
    if (!confirm('Reject this chore?')) return;
    
    fetch(`/family/{{ family.id }}/chores/assignment/${assignmentId}/reject`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Chore rejected', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error rejecting chore: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error rejecting chore', 'error');
    });
}

function unassignChore(assignmentId) {
    if (!confirm('Are you sure you want to unassign this chore? The chore will return to the unassigned list.')) return;
    
    fetch(`/family/{{ family.id }}/chores/assignment/${assignmentId}/unassign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Chore unassigned successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error unassigning chore: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error unassigning chore', 'error');
    });
}

function deleteChore(choreId, choreName) {
    if (!confirm(`Are you sure you want to permanently delete the chore "${choreName}"? This cannot be undone.`)) return;
    
    fetch(`/family/{{ family.id }}/chores/${choreId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Chore deleted successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error deleting chore: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting chore', 'error');
    });
}

function showCloneChoreModal(choreId, choreName) {
    currentChoreToClone = choreId;
    document.getElementById('cloneChoreDescription').textContent = `Clone "${choreName}" to another child`;
    document.getElementById('cloneChoreModal').classList.remove('hidden');
    
    const form = document.getElementById('cloneChoreForm');
    form.action = `/family/{{ family.id }}/chores/${choreId}/clone`;
}

function hideCloneChoreModal() {
    document.getElementById('cloneChoreModal').classList.add('hidden');
    currentChoreToClone = null;
}

function approveRedemption(redemptionId) {
    if (!confirm('Approve this reward redemption?')) return;
    
    fetch(`/family/{{ family.id }}/rewards/${redemptionId}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Reward redemption approved!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error approving redemption: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error approving redemption', 'error');
    });
}

function rejectRedemption(redemptionId) {
    if (!confirm('Reject this reward redemption? This will refund the coins/points.')) return;
    
    fetch(`/family/{{ family.id }}/rewards/${redemptionId}/reject`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Reward redemption rejected and coins/points refunded.', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error rejecting redemption: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error rejecting redemption', 'error');
    });
}

// Add form submission handler for cloning
document.getElementById('cloneChoreForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const assignedToId = this.querySelector('select[name="assigned_to_id"]').value;
    
    fetch(this.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            assigned_to_id: assignedToId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Chore cloned successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error cloning chore: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error cloning chore', 'error');
    });
});

// Close modals when clicking outside
document.getElementById('assignChoreModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideAssignChoreModal();
    }
});

document.getElementById('cloneChoreModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCloneChoreModal();
    }
});
</script>
{% endblock %}