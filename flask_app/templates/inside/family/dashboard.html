{% extends "inside/dashboard.html" %}

{% block dashboard_content %}
<div class="p-6">
    <h2 class="text-2xl font-bold mb-4">{{ family.name }} - Family Dashboard</h2>
    
    <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-semibold">Family Members</h3>
            {% if user.is_parent_in_family(family.id) %}
            <a href="{{ url_for('add_family_member', family_id=family.id) }}" 
               class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Add Family Member
            </a>
            {% endif %}
        </div>
        <div class="bg-white rounded-lg shadow">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PIN</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for member in members %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ member.user.first_name }} {{ member.user.last_name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{ member.role.title() }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if 'nologin' in member.user.email %}
                            <span class="text-gray-500">No login account</span>
                            {% else %}
                            {{ member.user.email }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if member.user.pin_code %}
                            <span class="text-green-600">{{ member.user.pin_code }}</span>
                            {% else %}
                            <span class="text-gray-500">No PIN</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if user.is_parent_in_family(family.id) and member.user_id != user.id %}
                            <div class="flex space-x-2">
                                <button onclick="editMember({{ member.id }})"
                                        class="text-blue-600 hover:text-blue-900">
                                    Edit
                                </button>
                                <button onclick="removeMember({{ member.id }}, '{{ member.user.first_name }}')"
                                        class="text-red-600 hover:text-red-900">
                                    Remove
                                </button>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-semibold">Family Budget</h3>
            {% if user.is_parent_in_family(family.id) %}
            <a href="{{ url_for('create_budget', family_id=family.id) }}" 
               class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Create New Budget
            </a>
            {% endif %}
        </div>
        
        {% if family.budgets %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for budget in family.budgets %}
            <div class="bg-white rounded-lg shadow p-4">
                <h4 class="font-bold text-lg mb-2">{{ budget.name }}</h4>
                <p class="text-gray-600 mb-2">{{ budget.description }}</p>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Total: ${{ "%.2f"|format(budget.total_amount) }}</span>
                    <a href="{{ url_for('view_budget', family_id=family.id, budget_id=budget.id) }}" 
                       class="text-blue-500 hover:text-blue-700">View Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-6 text-center">
            <p class="text-gray-600">No budgets created yet.</p>
            {% if user.is_parent_in_family(family.id) %}
            <a href="{{ url_for('create_budget', family_id=family.id) }}" 
               class="text-blue-500 hover:text-blue-700">Create your first budget</a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-semibold mb-4">Family Stats</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center">
                <p class="text-gray-600">Total Members</p>
                <p class="text-2xl font-bold">{{ members|length }}</p>
            </div>
            <div class="text-center">
                <p class="text-gray-600">Family Points</p>
                <p class="text-2xl font-bold">{{ family.total_points }}</p>
            </div>
            <div class="text-center">
                <p class="text-gray-600">Active Budgets</p>
                <p class="text-2xl font-bold">{{ family.budgets|length }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Member Modal -->
<div id="editMemberModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-semibold mb-4">Edit Family Member</h3>
            <form id="editMemberForm" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">First Name</label>
                    <input type="text" name="first_name" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Last Name</label>
                    <input type="text" name="last_name" required
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">Role</label>
                    <select name="role" required
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            onchange="togglePinField(this.value)">
                        <option value="parent">Parent</option>
                        <option value="guardian">Guardian</option>
                        <option value="child">Child</option>
                    </select>
                </div>
                <div id="pinSection" class="mb-4 hidden">
                    <label class="block text-gray-700 font-bold mb-2">PIN Code</label>
                    <input type="text" name="pin_code" maxlength="6" pattern="\d{4,6}"
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                           placeholder="4-6 digits">
                    <p class="text-sm text-gray-600 mt-1">Leave blank to keep current PIN</p>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="hideEditModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editMember(memberId) {
    const members = {{ members|map('serialize_member')|list|tojson|safe }};
    const member = members.find(m => m.id === memberId);
    if (!member) return;

    const form = document.getElementById('editMemberForm');
    form.action = `/family/{{ family.id }}/member/${memberId}/edit`;
    form.first_name.value = member.user.first_name;
    form.last_name.value = member.user.last_name;
    form.role.value = member.role;
    
    togglePinField(member.role);
    document.getElementById('editMemberModal').classList.remove('hidden');
}

function hideEditModal() {
    document.getElementById('editMemberModal').classList.add('hidden');
}

function togglePinField(role) {
    const pinSection = document.getElementById('pinSection');
    const pinInput = document.querySelector('input[name="pin_code"]');
    
    if (role === 'child') {
        pinSection.classList.remove('hidden');
        pinInput.required = true;
    } else {
        pinSection.classList.add('hidden');
        pinInput.required = false;
        pinInput.value = '';
    }
}

function removeMember(memberId, memberName) {
    if (!confirm(`Are you sure you want to remove ${memberName} from the family?`)) {
        return;
    }
    
    fetch(`/family/{{ family.id }}/member/${memberId}/remove`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error removing member: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing member');
    });
}

// Close modal when clicking outside
document.getElementById('editMemberModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideEditModal();
    }
});
</script>
{% endblock %} 